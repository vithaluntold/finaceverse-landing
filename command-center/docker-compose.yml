# FinACEverse Command Center - Phase 1 + Phase 2 + Phase 3 + Phase 4
# Version: 4.0
# Last Updated: January 16, 2026
# 
# Phase 1: Zitadel (Identity), Cerbos (AuthZ), Vault (Secrets), 
#          APISIX (API Gateway), SigNoz (APM), PostgreSQL
# Phase 2: Lago (Billing), Chatwoot (Support), BookStack (Knowledge Base)
# Phase 3: Accute Orchestrator (Workflows), Unleash (Feature Flags), Wazuh (SIEM)
# Phase 4: Metabase (Business Intelligence), Partner Portal (Custom)
#
# Usage: docker-compose up -d
# Dashboard URLs:
#   - Zitadel Console:    http://localhost:8080
#   - APISIX Dashboard:   http://localhost:9000
#   - SigNoz:             http://localhost:3301
#   - Vault:              http://localhost:8200
#   - Lago:               http://localhost:3000
#   - Chatwoot:           http://localhost:3100
#   - BookStack:          http://localhost:6875
#   - Orchestrator API:   http://localhost:3050
#   - Unleash:            http://localhost:4242
#   - Wazuh Dashboard:    http://localhost:5601
#   - Metabase:           http://localhost:3400
#   - Partner Portal API: http://localhost:3500

version: '3.8'

networks:
  finaceverse:
    driver: bridge

volumes:
  postgres_data:
  zitadel_data:
  vault_data:
  signoz_data:
  apisix_logs:
  lago_storage:
  chatwoot_storage:
  bookstack_data:
  orchestrator_data:
  unleash_data:
  wazuh_data:
  metabase_data:
  partner_portal_data:

services:
  # ============================================
  # DATABASE LAYER
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: finaceverse-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: finaceverse
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-FinACE_Secure_2026!}
      POSTGRES_DB: finaceverse
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - finaceverse
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U finaceverse"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # IDENTITY & ACCESS MANAGEMENT
  # ============================================
  
  # Zitadel - Identity Provider (SSO, OIDC, SAML)
  zitadel:
    image: ghcr.io/zitadel/zitadel:v2.45.0
    container_name: finaceverse-zitadel
    restart: unless-stopped
    command: start-from-init --masterkeyFromEnv --tlsMode disabled
    environment:
      ZITADEL_MASTERKEY: ${ZITADEL_MASTERKEY:-MasterkeyForFinACEverse2026SecureKey}
      ZITADEL_DATABASE_POSTGRES_HOST: postgres
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_USER: zitadel
      ZITADEL_DATABASE_POSTGRES_PASSWORD: ${ZITADEL_DB_PASSWORD:-Zitadel_Secure_2026!}
      ZITADEL_DATABASE_POSTGRES_SSL_MODE: disable
      ZITADEL_EXTERNALSECURE: "false"
      ZITADEL_EXTERNALDOMAIN: localhost
      ZITADEL_EXTERNALPORT: 8080
      ZITADEL_FIRSTINSTANCE_ORG_NAME: FinACEverse
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: superadmin
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: ${SUPERADMIN_PASSWORD:-SuperAdmin_2026!}
    ports:
      - "8080:8080"
    volumes:
      - zitadel_data:/data
      - ./config/zitadel:/config:ro
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy

  # Cerbos - Policy-Based Access Control
  cerbos:
    image: ghcr.io/cerbos/cerbos:0.32.0
    container_name: finaceverse-cerbos
    restart: unless-stopped
    command: server --config=/config/cerbos.yaml
    ports:
      - "3592:3592"  # gRPC
      - "3593:3593"  # HTTP
    volumes:
      - ./config/cerbos:/config:ro
      - ./policies:/policies:ro
    networks:
      - finaceverse

  # ============================================
  # SECRETS MANAGEMENT
  # ============================================
  
  # HashiCorp Vault - Secrets & Encryption
  vault:
    image: hashicorp/vault:1.15
    container_name: finaceverse-vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_ROOT_TOKEN:-finaceverse-dev-token}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    ports:
      - "8200:8200"
    volumes:
      - vault_data:/vault/file
      - ./config/vault:/vault/config:ro
    networks:
      - finaceverse

  # ============================================
  # API GATEWAY
  # ============================================
  
  # Apache APISIX - API Gateway
  apisix:
    image: apache/apisix:3.8.0-debian
    container_name: finaceverse-apisix
    restart: unless-stopped
    volumes:
      - ./config/apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
      - ./config/apisix/apisix.yaml:/usr/local/apisix/conf/apisix.yaml:ro
      - apisix_logs:/usr/local/apisix/logs
    ports:
      - "9080:9080"   # HTTP
      - "9443:9443"   # HTTPS
      - "9180:9180"   # Admin API
    networks:
      - finaceverse
    depends_on:
      - etcd

  # APISIX Dashboard
  apisix-dashboard:
    image: apache/apisix-dashboard:3.0.1-alpine
    container_name: finaceverse-apisix-dashboard
    restart: unless-stopped
    volumes:
      - ./config/apisix/dashboard.yaml:/usr/local/apisix-dashboard/conf/conf.yaml:ro
    ports:
      - "9000:9000"
    networks:
      - finaceverse
    depends_on:
      - apisix

  # etcd - APISIX configuration store
  etcd:
    image: bitnami/etcd:3.5
    container_name: finaceverse-etcd
    restart: unless-stopped
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
    networks:
      - finaceverse

  # ============================================
  # OBSERVABILITY
  # ============================================
  
  # SigNoz - APM & Tracing (All-in-one)
  signoz:
    image: signoz/signoz-otel-collector:0.88.11
    container_name: finaceverse-signoz-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./config/signoz/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - finaceverse

  signoz-frontend:
    image: signoz/frontend:0.38.0
    container_name: finaceverse-signoz-frontend
    restart: unless-stopped
    ports:
      - "3301:3301"
    environment:
      SIGNOZ_BACKEND_URL: http://signoz-query:8080
    networks:
      - finaceverse
    depends_on:
      - signoz-query

  signoz-query:
    image: signoz/query-service:0.38.0
    container_name: finaceverse-signoz-query
    restart: unless-stopped
    environment:
      ClickHouseUrl: tcp://clickhouse:9000
      STORAGE: clickhouse
    networks:
      - finaceverse
    depends_on:
      - clickhouse

  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: finaceverse-clickhouse
    restart: unless-stopped
    volumes:
      - signoz_data:/var/lib/clickhouse
    networks:
      - finaceverse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # ============================================
  # REDIS (Cache & Event Bus)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: finaceverse-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-Redis_Secure_2026!}
    ports:
      - "6379:6379"
    networks:
      - finaceverse

  # ============================================
  # PHASE 2: BILLING (Lago)
  # Module 1: Financial Operations Center
  # ============================================
  
  lago-api:
    image: getlago/api:v1.3.5
    container_name: finaceverse-lago-api
    restart: unless-stopped
    environment:
      LAGO_API_URL: http://localhost:3000
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-Lago_Secure_2026!}@postgres:5432/lago
      REDIS_URL: redis://:${REDIS_PASSWORD:-Redis_Secure_2026!}@redis:6379
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-your-secret-key-base-at-least-64-chars-long-for-production}
      RAILS_ENV: production
      LAGO_FRONT_URL: http://localhost:3000
      RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_KEY:-encryption-key-32-chars-minimum!}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_DETERMINISTIC_KEY:-deterministic-key-32-chars-min!}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_KEY_SALT:-key-derivation-salt-minimum-32!}
      LAGO_WEBHOOK_ATTEMPTS: 3
      LAGO_USE_AWS_S3: "false"
      SIDEKIQ_EVENTS: "true"
    ports:
      - "3000:3000"
    volumes:
      - lago_storage:/app/storage
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  lago-worker:
    image: getlago/api:v1.3.5
    container_name: finaceverse-lago-worker
    restart: unless-stopped
    command: bundle exec sidekiq -C config/sidekiq.yml
    environment:
      LAGO_API_URL: http://localhost:3000
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-Lago_Secure_2026!}@postgres:5432/lago
      REDIS_URL: redis://:${REDIS_PASSWORD:-Redis_Secure_2026!}@redis:6379
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-your-secret-key-base-at-least-64-chars-long-for-production}
      RAILS_ENV: production
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_KEY:-encryption-key-32-chars-minimum!}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_DETERMINISTIC_KEY:-deterministic-key-32-chars-min!}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_KEY_SALT:-key-derivation-salt-minimum-32!}
    networks:
      - finaceverse
    depends_on:
      - lago-api

  lago-front:
    image: getlago/front:v1.3.5
    container_name: finaceverse-lago-front
    restart: unless-stopped
    environment:
      API_URL: http://lago-api:3000
      APP_ENV: production
      LAGO_OAUTH_PROVIDERS_ENABLED: "false"
    ports:
      - "8081:80"
    networks:
      - finaceverse
    depends_on:
      - lago-api

  # ============================================
  # PHASE 2: SUPPORT (Chatwoot)
  # Module 5: Support Center
  # ============================================
  
  chatwoot:
    image: chatwoot/chatwoot:v3.5.0
    container_name: finaceverse-chatwoot
    restart: unless-stopped
    command: bundle exec rails s -p 3000 -b 0.0.0.0
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY:-chatwoot-secret-key-base-minimum-64-characters-long-for-security}
      FRONTEND_URL: http://localhost:3100
      DATABASE_URL: postgresql://chatwoot:${CHATWOOT_DB_PASSWORD:-Chatwoot_Secure_2026!}@postgres:5432/chatwoot
      REDIS_URL: redis://:${REDIS_PASSWORD:-Redis_Secure_2026!}@redis:6379
      POSTGRES_HOST: postgres
      POSTGRES_USERNAME: chatwoot
      POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD:-Chatwoot_Secure_2026!}
      POSTGRES_DATABASE: chatwoot
      RAILS_LOG_TO_STDOUT: "true"
      LOG_LEVEL: info
      DEFAULT_LOCALE: en
      ENABLE_ACCOUNT_SIGNUP: "false"
      MAILER_SENDER_EMAIL: support@finaceverse.com
      SMTP_DOMAIN: finaceverse.com
      SMTP_ADDRESS: ${SMTP_ADDRESS:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_AUTHENTICATION: plain
      SMTP_ENABLE_STARTTLS_AUTO: "true"
    ports:
      - "3100:3000"
    volumes:
      - chatwoot_storage:/app/storage
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  chatwoot-worker:
    image: chatwoot/chatwoot:v3.5.0
    container_name: finaceverse-chatwoot-worker
    restart: unless-stopped
    command: bundle exec sidekiq -C config/sidekiq.yml
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY:-chatwoot-secret-key-base-minimum-64-characters-long-for-security}
      DATABASE_URL: postgresql://chatwoot:${CHATWOOT_DB_PASSWORD:-Chatwoot_Secure_2026!}@postgres:5432/chatwoot
      REDIS_URL: redis://:${REDIS_PASSWORD:-Redis_Secure_2026!}@redis:6379
    networks:
      - finaceverse
    depends_on:
      - chatwoot

  # ============================================
  # PHASE 2: KNOWLEDGE BASE (BookStack)
  # Module 5: Support Center - Knowledge Base
  # ============================================
  
  bookstack:
    image: lscr.io/linuxserver/bookstack:24.02.3
    container_name: finaceverse-bookstack
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      APP_URL: http://localhost:6875
      DB_HOST: bookstack-db
      DB_PORT: 3306
      DB_USER: bookstack
      DB_PASS: ${BOOKSTACK_DB_PASSWORD:-BookStack_Secure_2026!}
      DB_DATABASE: bookstack
    ports:
      - "6875:80"
    volumes:
      - bookstack_data:/config
    networks:
      - finaceverse
    depends_on:
      - bookstack-db

  bookstack-db:
    image: mariadb:10.11
    container_name: finaceverse-bookstack-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${BOOKSTACK_ROOT_PASSWORD:-BookStack_Root_2026!}
      MYSQL_DATABASE: bookstack
      MYSQL_USER: bookstack
      MYSQL_PASSWORD: ${BOOKSTACK_DB_PASSWORD:-BookStack_Secure_2026!}
    networks:
      - finaceverse

  # ============================================
  # PHASE 3: ACCUTE ORCHESTRATOR
  # Module 7: AI Agent Factory - Custom Workflow Engine
  # ============================================
  
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: finaceverse-orchestrator
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://finaceverse:${POSTGRES_PASSWORD:-FinACE_Secure_2026!}@postgres:5432/orchestrator
      REDIS_URL: redis://orchestrator-redis:6379
      VAMN_API_URL: ${VAMN_API_URL:-http://vamn:3000}
      LUCA_API_URL: ${LUCA_API_URL:-http://luca:3000}
      ENABLE_AI_VERIFICATION: "true"
      AUDIT_LEVEL: detailed
      LOG_LEVEL: info
      MAX_CONCURRENT_EXECUTIONS: 100
      WORKER_CONCURRENCY: 10
      # OpenTelemetry
      OTEL_EXPORTER_OTLP_ENDPOINT: http://signoz-otel-collector:4317
      OTEL_SERVICE_NAME: accute-orchestrator
    ports:
      - "3050:3000"
    volumes:
      - orchestrator_data:/app/data
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy
      orchestrator-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  orchestrator-redis:
    image: redis:7-alpine
    container_name: finaceverse-orchestrator-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - orchestrator_data:/data
    networks:
      - finaceverse
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # PHASE 3: UNLEASH - Feature Flags
  # Module 3: DevOps Center - Feature Flags
  # ============================================
  
  unleash:
    image: unleashorg/unleash-server:5.9
    container_name: finaceverse-unleash
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://finaceverse:${POSTGRES_PASSWORD:-FinACE_Secure_2026!}@postgres:5432/unleash
      DATABASE_SSL: "false"
      LOG_LEVEL: info
      INIT_ADMIN_API_TOKENS: "*:*.unleash-admin-api-token-2026"
      INIT_CLIENT_API_TOKENS: "default:development.unleash-client-token-2026"
    ports:
      - "4242:4242"
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4242/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # PHASE 3: WAZUH - SIEM & Security Monitoring
  # Module 6: Security Operations - SIEM
  # ============================================
  
  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.2
    container_name: finaceverse-wazuh-manager
    restart: unless-stopped
    hostname: wazuh-manager
    environment:
      INDEXER_URL: https://wazuh-indexer:9200
      INDEXER_USERNAME: admin
      INDEXER_PASSWORD: ${WAZUH_INDEXER_PASSWORD:-Wazuh_Admin_2026!}
      FILEBEAT_SSL_VERIFICATION_MODE: full
      SSL_CERTIFICATE_AUTHORITIES: /etc/ssl/root-ca.pem
      SSL_CERTIFICATE: /etc/ssl/filebeat.pem
      SSL_KEY: /etc/ssl/filebeat.key
    volumes:
      - wazuh_data:/var/ossec/data
    ports:
      - "1514:1514/udp"
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    networks:
      - finaceverse

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.7.2
    container_name: finaceverse-wazuh-indexer
    restart: unless-stopped
    hostname: wazuh-indexer
    environment:
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      bootstrap.memory_lock: "true"
      discovery.type: single-node
      plugins.security.ssl.http.enabled: "false"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    networks:
      - finaceverse

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.7.2
    container_name: finaceverse-wazuh-dashboard
    restart: unless-stopped
    hostname: wazuh-dashboard
    environment:
      INDEXER_USERNAME: admin
      INDEXER_PASSWORD: ${WAZUH_INDEXER_PASSWORD:-Wazuh_Admin_2026!}
      WAZUH_API_URL: https://wazuh-manager
      DASHBOARD_USERNAME: admin
      DASHBOARD_PASSWORD: ${WAZUH_DASHBOARD_PASSWORD:-WazuhDashboard_2026!}
      API_USERNAME: wazuh-wui
      API_PASSWORD: ${WAZUH_API_PASSWORD:-WazuhAPI_2026!}
    ports:
      - "5601:5601"
    networks:
      - finaceverse
    depends_on:
      - wazuh-indexer
      - wazuh-manager

  # ============================================
  # PHASE 4: BUSINESS INTELLIGENCE
  # ============================================

  # Metabase - Business Intelligence & Analytics
  metabase:
    image: metabase/metabase:v0.48.3
    container_name: finaceverse-metabase
    restart: unless-stopped
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: metabase
      MB_DB_PASS: ${METABASE_DB_PASSWORD:-Metabase_Secure_2026!}
      MB_DB_HOST: postgres
      MB_ENCRYPTION_SECRET_KEY: ${METABASE_SECRET:-FinACEverse_Metabase_Secret_2026_Key}
    ports:
      - "3400:3000"
    volumes:
      - metabase_data:/metabase-data
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy

  # Partner Portal API - Custom Built
  partner-portal:
    build:
      context: ./partner-portal
      dockerfile: Dockerfile
    container_name: finaceverse-partner-portal
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3500
      DATABASE_URL: postgresql://partner_portal:${PARTNER_DB_PASSWORD:-PartnerPortal_2026!}@postgres:5432/partner_portal
      JWT_SECRET: ${PARTNER_JWT_SECRET:-FinACEverse_Partner_JWT_Secret_2026}
      REDIS_URL: redis://redis:6379
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET}
    ports:
      - "3500:3500"
    volumes:
      - partner_portal_data:/app/data
    networks:
      - finaceverse
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
